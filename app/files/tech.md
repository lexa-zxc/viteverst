# Технический анализ Vite сборки

## 1. Основные характеристики сборки

- **Базовый фреймворк**: Vite 6.3.4
- **Основной язык стилей**: SCSS (sass-embedded 1.87.0)
- **Тип проекта**: Многостраничный статический сайт
- **Основная цель**: Ультрабыстрая верстка HTML/CSS без фреймворков

## 2. Ключевые функциональные возможности

### 2.1 Система сборки

- **Режимы сборки**: 
  - `development` (без минификации, для разработки)
  - `production` (без минификации, но собранный)
  - `production-min` (с минификацией и оптимизацией изображений)

- **Выходные файлы**:
  - CSS: Собираются в единый файл `css/app.css`
  - JS: Собираются в единый файл `js/app.js`
  - HTML: Обрабатываются и копируются в корень `dist`
  - Изображения: Копируются в `dist/img/`
  - Шрифты: Копируются в `dist/fonts/`
  - Vendor: Копируются в `dist/vendor/`
  - Files: Копируются в `dist/files/`

- **Командные файлы**:
  - `dev.bat` - запуск режима разработки
  - `build.bat` - сборка без минификации
  - `build-min.bat` - сборка с минификацией
  - `preview.bat` - предпросмотр собранного проекта
  - `fonts.bat` - конвертация шрифтов TTF в WOFF2

### 2.2 Обработка HTML

- **Директивы включения файлов**:
  - Синтаксис: `@@include('path/to/file.html')`
  - Передача параметров: `@@include('file.html', {"param":"value"})`
  - Вложенные включения: поддерживаются рекурсивно

- **Экранирование кода**:
  - Защита содержимого тегов `<code>` и `<pre>` от обработки
  - Base64-кодирование для сохранения HTML внутри этих тегов

- **Обработка атрибутов**:
  - Удаление `crossorigin` и `type="module"` при сборке
  - Добавление атрибута `defer` для скриптов
  - Исправление путей в `src`, `href`, `srcset` и других атрибутах

- **Система алиасов в HTML**:
  - `@scss` → `scss/`
  - `@js` → `js/`
  - `@img` → `img/`
  - `@utils` → `js/utils/`
  - `@vendor` → `vendor/`
  - `@files` → `files/`
  - `@fonts` → `fonts/`

### 2.3 Обработка SCSS

- **Глобальный импорт**:
  - Поддержка шаблонов глобального импорта (vite-plugin-sass-glob-import)
  - Стиль: `compressed` (даже в dev для ускорения работы)

- **Постобработка CSS**:
  - Автопрефиксер (последние 5 версий браузеров)
  - Сортировка медиа-запросов по принципу mobile-first

- **Система алиасов в SCSS**:
  - `@fonts` → `../fonts`
  - `@img` → `../img`
  - `@scss` → `../scss`
  - `@css` → `../css`
  - `@vendor` → `../vendor`
  - `@files` → `../files`

- **Переменные с путями**:
  - Автоматическое создание SCSS-переменных с путями для использования в стилях

### 2.4 Работа с ресурсами

- **Многопоточная обработка**:
  - Параллельное копирование файлов (до CPU.length - 1 потоков)
  - Отслеживание прогресса и отображение статистики

- **Оптимизация изображений** (только в режиме production-min):
  - JPEG/JPG: сжатие с сохранением 80% качества
  - PNG: оптимизация с настройками качества 60-80%
  - GIF: оптимизация с уровнем 7
  - SVG: пропуск оптимизации для сохранения структуры

- **Конвертация шрифтов**:
  - Автоматическое преобразование TTF в WOFF2
  - Сохранение WOFF2 рядом с исходными TTF файлами
  - Опция принудительной перезаписи существующих WOFF2 файлов

### 2.5 Система адаптивных REM

- **Интеллектуальное масштабирование**:
  - Автоматическая установка размера шрифта для `<html>` в зависимости от разрешения
  - Настраиваемые коэффициенты для разных диапазонов разрешений
  - Базовое значение: 1rem ≈ 10px для удобства верстки

- **Преимущества над медиа-запросами**:
  - Меньше кода (не нужны десятки медиа-запросов)
  - Естественное пропорциональное масштабирование
  - Простота поддержки (изменения в одном файле)

## 3. Внутренняя структура и реализация

### 3.1 Плагины Vite (кастомные)

1. **fileInclude**:
   - Обработка директив @@include
   - Поддержка рекурсивных включений
   - Защита кода в тегах code и pre

2. **htmlAlias**:
   - Замена алиасов в HTML-атрибутах
   - Обработка URL в инлайн-стилях с background-image

3. **copyResources**:
   - Копирование ресурсов (изображения, шрифты, vendor, files)
   - Многопоточная обработка для больших объемов файлов

4. **fixFontPaths**:
   - Исправление путей к шрифтам в CSS после сборки

5. **processHtml**:
   - Удаление ненужных атрибутов (crossorigin, type="module")
   - Исправление путей в инлайн-стилях

6. **fixAssetsPaths**:
   - Исправление относительных путей в скриптах и HTML

7. **renameJs**:
   - Переименование JS файлов в app.js

8. **scssEntry**:
   - Создание точки входа для SCSS

9. **htmlReload**:
   - Горячая перезагрузка при изменении HTML файлов

10. **imageOptimization**:
    - Оптимизация изображений с помощью imagemin
    - Параллельная обработка и статистика сжатия

11. **scssAlias**:
    - Обработка алиасов в SCSS файлах
    - Постобработка CSS файлов

12. **fontConversion**:
    - Конвертация шрифтов TTF в WOFF2
    - Автоматическое определение уже сконвертированных шрифтов
    - Поддержка принудительной перезаписи существующих файлов

### 3.2 Вспомогательные функции и утилиты

- **fsUtils**:
  - Рекурсивное копирование директорий
  - Поиск HTML файлов для точек входа
  - Проверка формата изображений
  - Форматирование размера файла
  - Рекурсивный поиск изображений

- **Функции обработки кода**:
  - escapeCodeAndPre - экранирование тегов code и pre
  - unescapeCodeAndPre - восстановление экранированного кода
  - wrapHtmlProcessor - оборачивание HTML-процессора для защиты кода

- **Скрипты конвертации**:
  - convertFonts - основная функция конвертации TTF в WOFF2
  - fileExists - проверка существования файлов перед конвертацией

### 3.3 Структура конфигурации

- **Константы**:
  - APP_DIR, DIST_DIR - основные директории
  - PATHS - объект с путями к различным директориям
  - PROJECT_ALIASES, HTML_ALIASES, SCSS_ALIASES - алиасы для разных контекстов

- **Функция createConfig**:
  - Создание конфигурации в зависимости от режима сборки
  - Настройка плагинов, алиасов и других параметров

## 4. Оптимизационные возможности

### 4.1 Текущие оптимизации

- Параллельная обработка файлов и изображений
- Сжатие и оптимизация изображений
- Минификация CSS и JS в режиме production-min
- Сортировка и объединение медиа-запросов
- Экранирование блоков кода от обработки
- Преобразование относительных путей

### 4.2 Потенциальные улучшения

- Оптимизация производительности нестандартных плагинов
- Улучшение параллельной обработки для больших проектов
- Добавление кеширования для ускорения повторных сборок
- Оптимизация базовой конфигурации Vite
- Сокращение избыточного кода
- Применение современных API Node.js

## 5. Зависимости проекта

### 5.1 Основные зависимости

- **vite**: 6.3.4 - основной сборщик
- **sass-embedded**: 1.87.0 - компилятор SCSS
- **postcss**: 8.5.3 - обработчик CSS
- **autoprefixer**: 10.4.21 - автопрефиксер
- **postcss-sort-media-queries**: 5.2.0 - сортировка медиа-запросов
- **vite-plugin-sass-glob-import**: 5.0.0 - глобальный импорт SCSS
- **ttf2woff2**: 6.0.1 - конвертация шрифтов TTF в WOFF2

### 5.2 Зависимости для оптимизации изображений

- **imagemin**: 8.0.1 - базовая библиотека оптимизации
- **imagemin-gifsicle**: 7.0.0 - для GIF
- **imagemin-mozjpeg**: 10.0.0 - для JPEG
- **imagemin-pngquant**: 9.0.2 - для PNG
- **imagemin-svgo**: 10.0.1 - для SVG
- **vite-plugin-imagemin**: 0.6.1 - плагин интеграции с Vite

## 6. Структура проекта

```
/
├── app/                   # Исходные файлы
│   ├── html/              # HTML компоненты
│   ├── scss/              # SCSS стили
│   ├── js/                # JavaScript файлы
│   ├── img/               # Изображения
│   ├── fonts/             # Шрифты (TTF и сконвертированные WOFF2)
│   ├── vendor/            # Сторонние библиотеки
│   │   └── rem/           # Система адаптивного REM
│   ├── files/             # Файлы для скачивания
│   └── *.html             # HTML страницы (точки входа)
│
├── vite-config/           # Конфигурация Vite
│   ├── config/            # Файлы конфигурации
│   ├── plugins/           # Плагины для Vite
│   ├── scripts/           # Вспомогательные скрипты
│   ├── utils/             # Утилиты
│   └── vite.config.js     # Основная конфигурация Vite
│
├── dist/                  # Собранный проект
│   ├── css/               # Скомпилированные стили
│   ├── js/                # Скомпилированные скрипты
│   ├── img/               # Обработанные изображения
│   ├── fonts/             # Шрифты
│   ├── vendor/            # Сторонние библиотеки
│   ├── files/             # Файлы для скачивания
│   └── *.html             # Обработанные HTML страницы
│
├── public/                # Статические файлы
│
├── package.json           # Зависимости и скрипты
├── vite.config.js         # Импорт основной конфигурации
├── .gitignore             # Исключения для Git
├── dev.bat                # Запуск режима разработки
├── build.bat              # Сборка без минификации
├── build-min.bat          # Сборка с минификацией
├── preview.bat            # Предпросмотр проекта
└── fonts.bat              # Конвертация шрифтов
```